<!DOCTYPE html>



<html lang="en-us" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>Write barriers and an old Ruby bug - Thoughts from Alan</title>
<meta name="description" content="">

<link rel="icon" type="image/x-icon" href="https://alanwu.space/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://alanwu.space/favicon.png">



    





    
    
    

    
        <link rel="stylesheet" href="https://alanwu.space/css/style.e5ec8e96139fb72189ec799ef6fa88ee336396e113a051759e0ec060eadb5ecf.css" integrity="sha256-5eyOlhOftyGJ7Hme9vqI7jNjluEToFF1ng7AYOrbXs8=">
    







<meta property="og:title" content="Write barriers and an old Ruby bug" />
<meta property="og:description" content="Learn about the role write barriers play in garbage collection algorithms through CRuby&rsquo;s implementation and example animations." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://alanwu.space/post/write-barrier/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-07-22T06:27:34-04:00" />
<meta property="article:modified_time" content="2021-07-22T06:27:34-04:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Write barriers and an old Ruby bug"/>
<meta name="twitter:description" content="Learn about the role write barriers play in garbage collection algorithms through CRuby&rsquo;s implementation and example animations."/>











    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header"> 
            
                <h1 class="site-title">
    <a href="/">Thoughts from Alan</a>
</h1>

    <nav></nav>



            
        </header>
        <main id="main" tabindex="-1"> 
            
    
    
    <article class="post h-entry">
        <header class="post-header">
            <h1 class="p-name post-title">Write barriers and an old Ruby bug</h1>
        </header>
        <div class="content e-content">
            <p>Here is a program that crashes Ruby 2.7.0:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>hash <span style="color:#f92672">=</span> { <span style="color:#e6db74">a</span>: <span style="color:#66d9ef">Object</span><span style="color:#f92672">.</span>new }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GC</span><span style="color:#f92672">.</span>start
</span></span><span style="display:flex;"><span>hash<span style="color:#f92672">.</span>transform_values!{ <span style="color:#66d9ef">Object</span><span style="color:#f92672">.</span>new }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GC</span><span style="color:#f92672">.</span>start(<span style="color:#e6db74">full_mark</span>: <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GC</span><span style="color:#f92672">.</span>start
</span></span></code></pre></div><p>The crash message is scary and subtly hints at the presence of a bug:</p>
<pre tabindex="0"><code>[BUG] try to mark T_NONE object
</code></pre><p>In this post, I will explain the reason behind the crash and suggest some ways to avoid similar issues in the future.</p>
<h2 id="is-it-a-bug-in-the-garbage-collector">Is it a bug in the garbage collector?</h2>
<p>Since the program crashes without the help of third party C extensions and crashes even when Ruby is launched with <code>--disable-gems</code>, it&rsquo;s clear that the problem is in the Ruby runtime. Looking at the C stack trace, we can see that <code>gc.c</code> initiates the crash. How can we prove beyond a reasonable doubt that the GC itself is guilty of this crash? It turns out, there is a method, <code>GC.verify_internal_consistency</code> that can help us out.</p>
<p>Adding a call to this method right after the call to <code>transform_values!</code> in our reproducer, we get a different message:</p>
<pre tabindex="0"><code>verify_internal_consistency_reachable_i: WB miss (O-&gt;Y) T_HASH -&gt; T_OBJECT
crash.rb:4: [BUG] gc_verify_internal_consistency: found internal inconsistency.
</code></pre><p>Okay, it looks like some invariant that the GC cares about is not upheld, but what is a &ldquo;WB miss&rdquo;?</p>
<h2 id="incremental-mark-and-sweep">Incremental mark and sweep</h2>
<p>WB stands for write barrier so <code>gc_verify_internal_consistency</code> is telling us that there is a &ldquo;write barrier miss&rdquo;. To understand what write barriers are and what they are for, we first need to understand how the GC functions. Once upon a time, Ruby had a stop-the-world mark-and-sweep GC. &ldquo;Stop-the-world&rdquo; sounds grandiose, but it basically means no Ruby code is running while the GC is doing work. I made some animated slides to explain the stop-the-world GC algorithm. <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>

<style>
.hidden {
    display: none;
}
</style>

<div id="al-svg-1">
    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
        <style>
            .al-code {
                font-family: monospace;
            }
            .active-slide > rect {
                stroke: #4477AA;
            }
            .active-slide > text {
                fill: #4477AA;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">puts("foo")</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="3em" >foo[0] = "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="4em" >foo[1] = "third"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em">GC.start</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="0.7em">
            <animate id=root1 attributeName=y dur="1.0s" values="0.7em;4.3em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <g>
            <rect width=50 height=20 x=180 y=20 fill=white stroke=black />
            <text class="al-code" x=205 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
            <animate attributeName=opacity dur=1.7s values="0;1" begin=root1.begin />
        </g>

        <g opacity=0>
            <rect width=50 height=20 x=230 y=60 fill=white stroke=black />
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
            <animate attributeName=opacity dur=1.7s values="0;1" begin="root1.begin+0.3s" fill=freeze />
        </g>


        <g opacity=0>
            <rect width=50 height=20 x=200 y=100 fill=white stroke=black />
            <text class="al-code" x=225 y=112 font-size=10 textLength=45 text-anchor=middle>"second"</text>
            <line x1=225 y1=100 x2=255 y2=80 stroke=black />
            <animate attributeName=opacity dur=1.7s values="0;1" begin="root1.begin+0.6s" fill=freeze />
        </g>

        <g opacity=0>
            <rect width=50 height=20 x=238 y=130 fill=white stroke=black />
            <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
            <line x1=263 y1=130 x2=255 y2=80 stroke=black />
            <animate attributeName=opacity dur=1.7s values="0;1" begin="root1.begin+0.9" fill=freeze />
        </g>


        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153">Code allocates objects</text>

        <a xlink:href="#stop-the-world-1">
            <rect y="170" x="121" width="16" height="16" fill=white stroke=#4477AA></rect>
            <text class="al-code" y="182" x="129" font-size=10 text-anchor=middle textLength=10 fill=#4477AA>1</text>
        </a>
        <a xlink:href="#stop-the-world-2">
            <rect y="170" x="142" width="16" height="16" stroke=black fill=white></rect>
            <text class="al-code" y="182" x="150" font-size=10 text-anchor=middle textLength=10 >2</text>
        </a>
        <a xlink:href="#stop-the-world-3">
            <rect y="170" x="163" width="16" height="16" stroke=black fill=none></rect>
            <text class="al-code" y="182" x="171" font-size=10 text-anchor=middle textLength=10>3</text>

    </svg>

    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class=hidden>
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">puts("foo")</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="3em" >foo[0] = "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="4em" >foo[1] = "third"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em">GC.start</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root2 attributeName=y dur="1.0s" values="4.3em;5.1em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <g>
            <rect width=50 height=20 x=180 y=20 fill=white stroke=black />
            <text class="al-code" x=205 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
        </g>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=230 y=60 fill=#CCBB44 stroke=black>
                <animate begin="root2.begin" attributeName=fill values="#CCBB44; #CCBB44; #CCBB44; #228833" fill=freeze dur="3s" keyTimes="0;0.33;0.8;1" />
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
        </g>


        <rect width=50 height=20 x=200 y=100 fill=white stroke=black>
            <animate attributeName=fill dur=1s values="white;#CCBB44" fill=freeze begin="root2.begin+1" />
            <animate attributeName=fill dur=1s values="#CCBB44;#228833" fill=freeze begin="root2.begin+3.5" />
        </rect>
        <text class="al-code" x=225 y=112 font-size=10 textLength=45 text-anchor=middle>"second"</text>
        <line x1=225 y1=100 x2=255 y2=80 stroke=black>
            <animate begin="root2.begin" attributeName=stroke values="black; #CCBB44; #CCBB44; black" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
            <animate begin="root2.begin" attributeName=stroke-width values="1; 3; 3; 1" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
        </line>

        <rect width=50 height=20 x=238 y=130 fill=white stroke=black>
            <animate begin="root2.begin+1" attributeName=fill dur=1s values="white;#CCBB44" fill=freeze />
            <animate begin="root2.begin+3.5" attributeName=fill dur=1s values="#CCBB44;#228833" fill=freeze />
        </rect>
        <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
        <line x1=263 y1=130 x2=255 y2=80 stroke=black>
            <animate begin="root2.begin" attributeName=stroke values="black; #CCBB44; #CCBB44; black" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
            <animate begin="root2.begin" attributeName=stroke-width values="1; 3; 3; 1" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
        </line>

        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153">GC runs</text>
        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>Starts knowing `foo` needs marking</text>

        <a xlink:href="#stop-the-world-1">
            <rect y="170" x="121" width="16" height="16" fill=white stroke=black></rect>
            <text class="al-code" y="182" x="129" font-size=10 text-anchor=middle textLength=10 fill=black>1</text>
        </a>
        <a xlink:href="#stop-the-world-2">
            <rect y="170" x="142" width="16" height="16" stroke=#4477AA fill=white></rect>
            <text class="al-code" y="182" x="150" font-size=10 text-anchor=middle textLength=10 fill=#4477AA>2</text>
        </a>
        <a xlink:href="#stop-the-world-3">
            <rect y="170" x="163" width="16" height="16" stroke=black fill=none></rect>
            <text class="al-code" y="182" x="171" font-size=10 text-anchor=middle textLength=10>3</text>
        </a>

    </svg>

    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class=hidden>
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">puts("foo")</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="3em" >foo[0] = "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="4em" >foo[1] = "third"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em">GC.start</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="5.1em">
        </rect>

        <g>
            <rect width=50 height=20 x=180 y=20 fill=white stroke=black />
            <text class="al-code" x=205 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
        </g>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=230 y=60 fill=#228833 stroke=black>
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
        </g>


        <rect width=50 height=20 x=200 y=100 fill=#228833 stroke=black>
        </rect>
        <text class="al-code" x=225 y=112 font-size=10 textLength=45 text-anchor=middle>"second"</text>
        <line x1=225 y1=100 x2=255 y2=80 stroke=black>
        </line>

        <rect width=50 height=20 x=238 y=130 fill=#228833 stroke=black>
        </rect>
        <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
        <line x1=263 y1=130 x2=255 y2=80 stroke=black>
        </line>

        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>Done. "first" can be released</text>

        <a xlink:href="#stop-the-world-1">
            <rect y="170" x="121" width="16" height="16" fill=white stroke=black></rect>
            <text class="al-code" y="182" x="129" font-size=10 text-anchor=middle textLength=10 fill=black>1</text>
        </a>
        <a xlink:href="#stop-the-world-2">
            <rect y="170" x="142" width="16" height="16" stroke=black fill=white></rect>
            <text class="al-code" y="182" x="150" font-size=10 text-anchor=middle textLength=10>2</text>
        </a>
        <a xlink:href="#stop-the-world-3">
            <rect y="170" x="163" width="16" height="16" stroke=#4477AA fill=none></rect>
            <text class="al-code" y="182" x="171" font-size=10 text-anchor=middle fill=#4477AA textLength=10>3</text>
        </a>

    </svg>
</div>


<p>This works okay, with one disadvantage: when there are many objects alive, the GC could pause Ruby code execution for an unacceptably long amount of time. Pausing for just 17 milliseconds in a video game could be devastating as that can easily make the game miss its frame rate target.</p>
<p>To deal with this problem, we could break up the work the GC has to do into chunks and interleave them with Ruby code execution. To go back to the video game example, instead of pausing for say 17 milliseconds a single time, we pause for 1 millisecond 17 times, allowing Ruby code to execute between pauses. If the game has 17 milliseconds to render each frame, instead of taking up 17 milliseconds once in a while, blowing through the frame time budget, the GC now takes up 1 millisecond once in a while. The GC potentially takes longer to release garbage objects, because the total amount of work is still the same as before, but that should be okay for a lot of applications.</p>

<div id="al-svg-2">
    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = []</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[0] << "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root3 attributeName=y dur="1.0s" values=".8em;2.6em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <g>
            <rect width=50 height=20 x=180 y=20 fill=white stroke=black />
            <text class="al-code" x=205 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
            <animate begin=root3.begin attributeName=opacity dur=1.7s values="0;1" />
        </g>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g opacity=0>
            <rect width=50 height=20 x=230 y=60 fill=none stroke=black>
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
            <animate attributeName=opacity dur=1.7s values="0;1" begin=root3.begin+0.3 fill=freeze />
        </g>


        <g opacity=0>
            <rect width=50 height=20 x=200 y=95 fill=none stroke=black>
            </rect>
            <text class="al-code" x=225 y=105 dominant-baseline=middle font-size=10 text-anchor=middle>[]</text>
            <line x1=225 y1=95 x2=255 y2=80 stroke=black>
            </line>
            <animate attributeName=opacity dur=1.7s values="0;1" begin="root3.begin+0.7" fill=freeze />
        </g>

        <g opacity=0>
            <rect width=50 height=20 x=238 y=130 fill=none stroke=black>
            </rect>
            <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
            <line x1=263 y1=130 x2=225 y2=115 stroke=black>
            </line>
        </g>

        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>Code allocates objects</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#incremental-1" class="active-slide">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#incremental-2">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#incremental-3">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#incremental-4">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>

    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class=hidden>
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = []</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[0] << "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root4 attributeName=y dur="1.0s" values="2.6em;3.4em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <g>
            <rect width=50 height=20 x=180 y=20 fill=white stroke=black />
            <text class="al-code" x=205 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
        </g>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=230 y=60 fill=none stroke=black>
                <animate begin=root4.begin attributeName=fill values="#CCBB44; #CCBB44; #CCBB44; #228833" fill=freeze dur="3s" keyTimes="0;0.33;0.8;1" />
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
        </g>

        <g>
            <rect width=50 height=20 x=200 y=95 fill=none stroke=black>
                <animate attributeName=fill dur=1s values="white;#CCBB44" fill=freeze begin=root4.begin+1 />
            </rect>
            <text class="al-code" x=225 y=105 dominant-baseline=middle font-size=10 text-anchor=middle>[]</text>
            <line x1=225 y1=95 x2=255 y2=80 stroke=black>
                <animate begin=root4.begin attributeName=stroke values="black; #CCBB44; #CCBB44; black" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
                <animate begin=root4.begin attributeName=stroke-width values="1; 3; 3; 1" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
            </line>
        </g>

        <g opacity=0>
            <rect width=50 height=20 x=238 y=130 fill=none stroke=black>
            </rect>
            <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
            <line x1=263 y1=130 x2=225 y2=115 stroke=black>
            </line>
        </g>

        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>GC runs for a bit and stops halfway</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#incremental-1">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#incremental-2" class="active-slide">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#incremental-3">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#incremental-4">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>

    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class=hidden>
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = []</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[0] << "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root5 attributeName=y dur="1.0s" values="3.4em;4.3em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <g>
            <rect width=50 height=20 x=180 y=20 fill=white stroke=black />
            <text class="al-code" x=205 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
        </g>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=230 y=60 fill=#228833 stroke=black>
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
        </g>

        <g>
            <rect width=50 height=20 x=200 y=95 fill=#CCBB44 stroke=black>
            </rect>
            <text class="al-code" x=225 y=105 dominant-baseline=middle font-size=10 text-anchor=middle>[]</text>
            <line x1=225 y1=95 x2=255 y2=80 stroke=black>
            </line>
        </g>

        <g opacity=0>
            <rect width=50 height=20 x=238 y=130 fill=none stroke=black>
            </rect>
            <text class="al-code" x=263 y=143 font-size=10 textLength=45 text-anchor=middle>"second"</text>
            <line x1=263 y1=130 x2=225 y2=115 stroke=black>
            </line>
            <animate begin=root5.begin attributeName=opacity dur=1.7s values="0;1" fill=freeze />
        </g>

        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>Code resumes</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#incremental-1">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#incremental-2">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#incremental-3" class="active-slide">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#incremental-4">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>

    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class=hidden>
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = []</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[0] << "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root6 attributeName=y dur="1.0s" values="4.3em;5.1em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <g>
            <rect width=50 height=20 x=180 y=20 fill=white stroke=black />
            <text class="al-code" x=205 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
        </g>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=230 y=60 fill=#228833 stroke=black>
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
        </g>

        <g>
            <rect width=50 height=20 x=200 y=95 fill=#CCBB44 stroke=black>
                <animate begin=root6.begin attributeName=fill values="#CCBB44; #CCBB44; #CCBB44; #228833" fill=freeze dur="3s" keyTimes="0;0.33;0.8;1" />
            </rect>
            <text class="al-code" x=225 y=105 dominant-baseline=middle font-size=10 text-anchor=middle>[]</text>
            <line x1=225 y1=95 x2=255 y2=80 stroke=black>
            </line>
        </g>

        <g>
            <rect width=50 height=20 x=238 y=130 fill=none stroke=black>
                <animate attributeName=fill dur=1s values="white;#CCBB44" fill=freeze begin=root6.begin+1 />
                <animate attributeName=fill dur=1s values="#CCBB44;#228833" fill=freeze begin=root6.begin+3.2 />
            </rect>
            <text class="al-code" x=263 y=143 font-size=10 textLength=45 text-anchor=middle>"second"</text>
            <line x1=263 y1=130 x2=225 y2=115 stroke=black>
                <animate begin=root6.begin attributeName=stroke values="black; #CCBB44; #CCBB44; black" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
                <animate begin=root6.begin attributeName=stroke-width values="1; 3; 3; 1" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
            </line>
        </g>

        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>GC resumes and completes</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#incremental-1">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#incremental-2">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#incremental-3">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#incremental-4" class="active-slide">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>
</div>


<h2 id="write-barriers">Write barriers</h2>
<p>Great, we now have an incremental GC but we have also introduced a new problem. What happens if we finish marking an object <code>O</code>, let Ruby code execute, and the Ruby code associates <code>O</code> with an object <code>J</code> that would otherwise be unreachable?</p>

<div id="al-svg-3">
    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <text class=al-code font-size=6 y=195 x=6 textLength=80>Missing write barrier</text>

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[1] = "third"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root7 attributeName=y dur="1.0s" values="0.8em;2.6em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=190 y=20 fill=white stroke=black />
            <text class="al-code" x=215 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
            <animate begin=root7.begin attributeName=opacity dur=1.7s values="0;1" />
        </g>

        <g opacity=0>
            <rect width=50 height=20 x=230 y=60 fill=white stroke=black />
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
            <animate attributeName=opacity dur=1.7s values="0;1" begin=root7.begin+0.3 fill=freeze />
        </g>


        <g opacity=0>
            <rect width=50 height=20 x=200 y=100 fill=white stroke=black />
            <text class="al-code" x=225 y=112 font-size=10 textLength=45 text-anchor=middle>"second"</text>
            <line x1=225 y1=100 x2=255 y2=80 stroke=black />
            <animate attributeName=opacity dur=1.7s values="0;1" begin=root7.begin+0.6 fill=freeze />
        </g>

        <g opacity=0>
            <rect width=50 height=20 x=238 y=130 fill=white stroke=black />
            <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
            <line x1=263 y1=130 x2=255 y2=80 stroke=black />
        </g>


        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>Code runs</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#missing-wb-1" class="active-slide">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#missing-wb-2">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#missing-wb-3">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#missing-wb-4">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>

    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class=hidden>
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <text class=al-code font-size=6 y=195 x=6 textLength=80>Missing write barrier</text>

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[1] = "third"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root8 attributeName=y dur="1.0s" values="2.6em;3.4em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=190 y=20 fill=white stroke=black />
            <text class="al-code" x=215 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
        </g>

        <g>
            <rect width=50 height=20 x=230 y=60 fill=none stroke=black>
                <animate begin=root8.begin attributeName=fill values="#CCBB44; #CCBB44; #CCBB44; #228833" fill=freeze dur="3s" keyTimes="0;0.33;0.8;1" />
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
        </g>

        <g>
            <rect width=50 height=20 x=200 y=100 fill=white stroke=black>
                <animate attributeName=fill dur=1s values="white;#CCBB44" fill=freeze begin=root8.begin+1 />
                <animate attributeName=fill dur=1s values="#CCBB44;#228833" fill=freeze begin=root8.begin+3.1 />
            </rect>
            <text class="al-code" x=225 y=112 font-size=10 textLength=45 text-anchor=middle>"second"</text>
            <line x1=225 y1=100 x2=255 y2=80 stroke=black>
                <animate begin=root8.begin attributeName=stroke values="black; #CCBB44; #CCBB44; black" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
                <animate begin=root8.begin attributeName=stroke-width values="1; 3; 3; 1" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
            </line>
        </g>


        <g opacity=0>
            <rect width=50 height=20 x=238 y=130 fill=white stroke=black />
            <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
            <line x1=263 y1=130 x2=255 y2=80 stroke=black />
        </g>


        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>GC runs and finishes marking {}</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#incremental-1">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#incremental-2" class="active-slide">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#incremental-3">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#incremental-4">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>

    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class=hidden>
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <text class=al-code font-size=6 y=195 x=6 textLength=80>Missing write barrier</text>

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[1] = "third"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root9 attributeName=y dur="1.0s" values="3.4em;4.3em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=190 y=20 fill=white stroke=black />
            <text class="al-code" x=215 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
        </g>

        <g>
            <rect width=50 height=20 x=230 y=60 fill=#228833 stroke=black>
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
        </g>

        <g>
            <rect width=50 height=20 x=200 y=100 fill=#228833 stroke=black>
            </rect>
            <text class="al-code" x=225 y=112 font-size=10 textLength=45 text-anchor=middle>"second"</text>
            <line x1=225 y1=100 x2=255 y2=80 stroke=black>
            </line>
        </g>


        <g opacity=0>
            <rect width=50 height=20 x=238 y=130 fill=white stroke=black />
            <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
            <line x1=263 y1=130 x2=255 y2=80 stroke=black />
            <animate begin=root9.begin attributeName=opacity dur=1.7s values="0;1" fill=freeze />
        </g>


        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>Code adds new reference</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#incremental-1">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#incremental-2">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#incremental-3" class="active-slide">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#incremental-4">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>

    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class=hidden>
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <text class=al-code font-size=6 y=195 x=6 textLength=80>Missing write barrier</text>

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[1] = "third"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root10 attributeName=y dur="1.0s" values="4.3em;5.0em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=190 y=20 fill=white stroke=black />
            <text class="al-code" x=215 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
        </g>

        <g>
            <rect width=50 height=20 x=230 y=60 fill=#228833 stroke=black>
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
        </g>

        <g>
            <rect width=50 height=20 x=200 y=100 fill=#228833 stroke=black>
            </rect>
            <text class="al-code" x=225 y=112 font-size=10 textLength=45 text-anchor=middle>"second"</text>
            <line x1=225 y1=100 x2=255 y2=80 stroke=black>
            </line>
        </g>


        <g>
            <rect width=50 height=20 x=238 y=130 fill=white stroke=black />
            <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
            <line x1=263 y1=130 x2=255 y2=80 stroke=black />
        </g>


        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>"third" incorrectly treated as garbage</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#incremental-1">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#incremental-2">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#incremental-3">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#incremental-4" class="active-slide">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>
</div>


<p>We know <code>J</code> is alive since <code>O</code> is alive and all objects referenced by alive objects are also alive. However <code>O</code> is already marked, so the GC will not mark it again to see that <code>O</code> now refers to an object it didn&rsquo;t see the first time <code>O</code> was marked. Nevertheless, the GC cannot treat <code>J</code> as garbage. We need some way to address this problem.</p>
<p>We could make the Ruby code inform the GC every time it associates an object with another one. This way, when the Ruby code makes changes to an object the GC already marked the GC could be aware of objects that it potentially was unaware of at the time of marking:</p>

<div id="al-svg-4">
    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <text class=al-code font-size=6 y=195 x=6 textLength=65>With write barrier</text>

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[1] = "third"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root11 attributeName=y dur="1.0s" values="0.8em;2.6em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=190 y=20 fill=white stroke=black />
            <text class="al-code" x=215 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
            <animate begin=root11.begin attributeName=opacity dur=1.7s values="0;1" />
        </g>

        <g opacity=0>
            <rect width=50 height=20 x=230 y=60 fill=white stroke=black />
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
            <animate attributeName=opacity dur=1.7s values="0;1" begin=root11.begin+0.3 fill=freeze />
        </g>


        <g opacity=0>
            <rect width=50 height=20 x=200 y=100 fill=white stroke=black />
            <text class="al-code" x=225 y=112 font-size=10 textLength=45 text-anchor=middle>"second"</text>
            <line x1=225 y1=100 x2=255 y2=80 stroke=black />
            <animate attributeName=opacity dur=1.7s values="0;1" begin=root11.begin+0.6 fill=freeze />
        </g>

        <g opacity=0>
            <rect width=50 height=20 x=238 y=130 fill=white stroke=black />
            <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
            <line x1=263 y1=130 x2=255 y2=80 stroke=black />
        </g>


        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>Code runs</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#write-barrier-1" class="active-slide">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#write-barrier-2">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#write-barrier-3">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#write-barrier-4">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>

    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class=hidden>
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <text class=al-code font-size=6 y=195 x=6 textWidth=65>With write barrier</text>

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[1] = "third"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root12 attributeName=y dur="1.0s" values="2.6em;3.4em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=190 y=20 fill=white stroke=black />
            <text class="al-code" x=215 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
        </g>

        <g>
            <rect width=50 height=20 x=230 y=60 fill=none stroke=black>
                <animate begin=root12.begin attributeName=fill values="#CCBB44; #CCBB44; #CCBB44; #228833" fill=freeze dur="3s" keyTimes="0;0.33;0.8;1" />
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
        </g>

        <g>
            <rect width=50 height=20 x=200 y=100 fill=white stroke=black>
                <animate attributeName=fill dur=1s values="white;#CCBB44" fill=freeze begin="root12.begin+1" />
                <animate attributeName=fill dur=1s values="#CCBB44;#228833" fill=freeze begin=root12.begin+3.1 />
            </rect>
            <text class="al-code" x=225 y=112 font-size=10 textLength=45 text-anchor=middle>"second"</text>
            <line x1=225 y1=100 x2=255 y2=80 stroke=black>
                <animate begin=root12.begin attributeName=stroke values="black; #CCBB44; #CCBB44; black" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
                <animate begin=root12.begin attributeName=stroke-width values="1; 3; 3; 1" fill=freeze dur="3s" keyTimes="0;0.33;0.66;1" />
            </line>
        </g>


        <g opacity=0>
            <rect width=50 height=20 x=238 y=130 fill=white stroke=black />
            <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
            <line x1=263 y1=130 x2=255 y2=80 stroke=black />
        </g>


        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>GC runs and finishes marking {}</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#write-barrier-1">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#write-barrier-2" class="active-slide">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#write-barrier-3">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#write-barrier-4">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>

    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class=hidden>
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <text class=al-code font-size=6 y=195 x=6 textWidth=65>With write barrier</text>

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[1] = "third"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root13 attributeName=y dur="1.0s" values="3.4em;4.3em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=190 y=20 fill=white stroke=black />
            <text class="al-code" x=215 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
        </g>

        <g>
            <rect width=50 height=20 x=230 y=60 fill=#228833 stroke=black>
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
        </g>

        <g>
            <rect width=50 height=20 x=200 y=100 fill=#228833 stroke=black>
            </rect>
            <text class="al-code" x=225 y=112 font-size=10 textLength=45 text-anchor=middle>"second"</text>
            <line x1=225 y1=100 x2=255 y2=80 stroke=black>
            </line>
        </g>


        <g opacity=0>
            <rect width=50 height=20 x=238 y=130 fill=white stroke=black>
                <animate attributeName=fill dur=0.8s values="white;#CCBB44" begin=root13.begin+1.6 fill=freeze />
            </rect>
            <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
            <animate attributeName=opacity dur=1.0s values="0;1" fill=freeze begin=root13.begin />
            <line x1=263 y1=130 x2=255 y2=80 stroke=black>
                <animate attributeName=stroke-width dur=0.8s values="1;2.5;1" begin=root13.begin+1 fill=freeze />
            </line>
        </g>


        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>Code adds new reference with write barrier</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#write-barrier-1">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#write-barrier-2">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#write-barrier-3" class="active-slide">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#write-barrier-4">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>

    <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class=hidden>
        <style>
            .al-code {
                font-family: monospace;
            }
        </style>
        <rect width=300 height=200 fill=white stroke="grey" stroke-width="5px" />

        <text class=al-code font-size=6 y=195 x=6 textLength=65>With write barrier</text>

        <g transform="translate(25 10)">
            <text class="al-code" font-size=15 y="1em" dy="0em">foo = "first"</text>
            <text class="al-code" font-size=15 y="1em" dy="1em">foo = {}</text>
            <text class="al-code" font-size=15 y="1em" dy="2em">foo[0] = "second"</text>
            <text class="al-code" font-size=15 y="1em" dy="3em"># GC step</text>
            <text class="al-code" font-size=15 y="1em" dy="4em">foo[1] = "third"</text>
            <text class="al-code" font-size=15 y="1em" dy="5em"># GC step</text>
        </g>

        <rect fill="#EE6677" width="6" height="6" rx="1" x="13" y="1.3em">
            <animate id=root14 attributeName=y dur="1.0s" values="4.3em;5.0em" fill=freeze calcMode=spline keySplines="0.23 0.73 0.7 1" />
        </rect>

        <text textAnchor=middle x=13 y=120 font-size=10 text-decoration=underline>Legend</text>
        <rect fill=white width="6" height="6" stroke=black rx="1" x="13" y="125" />
        <text class=al-code x=22 y=130 font-size=6>Not marked</text>
        <rect fill=#CCBB44 width="6" height="6" stroke=black rx="1" x="13" y=134 />
        <text class=al-code x=22 y=139 font-size=6>Yet to be marked. Propagate, then become marked.</text>
        <rect fill=#228833 width="6" height="6" stroke=black rx="1" x="13" y=143 />
        <text class=al-code x=22 y=148 font-size=6>Marked</text>

        <g>
            <rect width=50 height=20 x=190 y=20 fill=white stroke=black />
            <text class="al-code" x=215 y=32 font-size=11 textLength=40 text-anchor=middle>"first"</text>
        </g>

        <g>
            <rect width=50 height=20 x=230 y=60 fill=#228833 stroke=black>
            </rect>
            <text class="al-code" x=255 y=73 font-size=11 text-anchor=middle>{}</text>
        </g>

        <g>
            <rect width=50 height=20 x=200 y=100 fill=#228833 stroke=black>
            </rect>
            <text class="al-code" x=225 y=112 font-size=10 textLength=45 text-anchor=middle>"second"</text>
            <line x1=225 y1=100 x2=255 y2=80 stroke=black>
            </line>
        </g>

        <g>
            <rect width=50 height=20 x=238 y=130 fill=#CCBB44 stroke=black>
                <animate attributeName=fill dur=1s values="#CCBB44;#228833" begin=root14.begin+0.5 fill=freeze />
            </rect>
            <text class="al-code" x=263 y=143 font-size=10 textLength=40 text-anchor=middle>"third"</text>
            <line x1=263 y1=130 x2=255 y2=80 stroke=black />
        </g>


        <text class="al-code" font-size="10" text-anchor="middle" x="150" y="153" dy=1em>GC completes correctly</text>

        <svg viewBox="0 0 100 20" width=100 height=20 y=170 x=101>
            <a xlink:href="#write-barrier-1">
                <rect y="2" x="5" width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x=13 font-size=10 dominant-baseline=middle text-anchor=middle textLength=10 fill=black>1</text>
            </a>
            <a xlink:href="#write-barrier-2">
                <rect y=2 x=26 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="34" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>2</text>
            </a>
            <a xlink:href="#write-barrier-3">
                <rect y=2 x=47 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="55" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>3</text>
            </a>
            <a xlink:href="#write-barrier-4" class="active-slide">
                <rect y=2 x=68 width="16" height="16" stroke=black fill=white></rect>
                <text class="al-code" y="10" x="76" font-size=10 dominant-baseline=middle text-anchor=middle textLength=10>4</text>
            </a>
        </svg>
    </svg>
</div>

<script>
(function(){
    function setupButtons(root) {
        const slideCount = root.children.length;
        let buttons = root.querySelectorAll("svg>a");
        for (let button of buttons) {
            // These are SVGAElement.
            let href = button.href.baseVal;
            let lastChar = href.charAt(href.length-1);
            let lastCharAsNum = Number.parseInt(lastChar);
            let transitionTo = lastCharAsNum-1;
            if (transitionTo >= 0 && transitionTo < slideCount) {
                button.addEventListener("click", function(clickEv) {
                    clickEv.preventDefault(); // To prevent changing the URI fragment.
                    for (let idx=0; idx<slideCount; idx++) {
                        let slideElement = root.children[idx];
                        if (idx == transitionTo) {
                            slideElement.classList.remove("hidden");
                        } else if (!slideElement.classList.contains("hidden")) {
                            slideElement.classList.add("hidden");
                        }
                    }
                    root.querySelectorAll("animate").forEach(e => {
                        // Hack for restarting the SVG animation timeline.
                        // Reinsert all elements then kick the animation on the syncbase element
                        // that all the animate elements are based off of.
                        let parent = e.parentNode;
                        parent.removeChild(e);
                        parent.insertAdjacentHTML("beforeend", e.outerHTML);
                        if (e.id.startsWith("root")) {
                            parent.children[parent.children.length-1].beginElement();
                        }
                    });
                });
            } else {
                console.error("failed finding index for transition button", button);
            }
        }
    }
    setupButtons(document.getElementById("al-svg-1"));
    setupButtons(document.getElementById("al-svg-2"));
    setupButtons(document.getElementById("al-svg-3"));
    setupButtons(document.getElementById("al-svg-4"));
})();
</script>


<p>The write barrier is a piece of code that informs the GC every time an object starts to reference a new object. In addition to facilitating incremental GC, write barriers also help with generational GC.</p>
<h2 id="how-to-miss-a-write-barrier">How to &ldquo;miss&rdquo; a write barrier</h2>
<p>Going back to our crash reproducer, we can now guess that <code>Hash#transform_values!</code> is missing a write barrier somewhere. After all, it&rsquo;s the only thing that can mutate the object reference graph after the GC runs. <a href="https://github.com/ruby/ruby/pull/2964">This indeed was the problem</a>.</p>
<p>There are many garbage collected languages that ship with compilers that can automatically insert write barriers. CRuby does not have that luxury, however, and it is up to the developers to manually insert write barriers where necessary. In this particular case a write barrier was present but erroneously removed.</p>
<h2 id="consequences">Consequences</h2>
<p>Missing write barriers can make the GC collect live objects and lead to <a href="https://en.wikipedia.org/w/index.php?title=Use_after_free">use-after-free</a>. This can lead to crashes like we have seen, or worse, silent data corruption. The following program demonstrates data corruption:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>hash <span style="color:#f92672">=</span> { <span style="color:#e6db74">a</span>: <span style="color:#66d9ef">Object</span><span style="color:#f92672">.</span>new }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GC</span><span style="color:#f92672">.</span>start
</span></span><span style="display:flex;"><span>hash<span style="color:#f92672">.</span>transform_values!{ <span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">99</span> }
</span></span><span style="display:flex;"><span>p hash
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GC</span><span style="color:#f92672">.</span>start(<span style="color:#e6db74">full_mark</span>: <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>p hash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">=begin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">$ ruby -v corrupt.rb
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">ruby 2.7.0p0 (2019-12-25 revision 647ee6f091) [x86_64-darwin19]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">{:a=&gt;633825300114114700748351602688}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">{:a=&gt;&#34;:a&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">=end</span>
</span></span></code></pre></div><p>Running the GC should not have visible impact on live objects.</p>
<h2 id="possible-ways-to-prevent-this-in-the-future">Possible ways to prevent this in the future</h2>
<p>To quote Koichi Sasada in a <a href="https://www.atdot.net/~ko1/activities/rgengc_ismm.pdf">paper</a> about CRuby&rsquo;s write barriers:</p>
<blockquote>
<p>In general, inserting WBs correctly is a difficult and time-consuming task because WB-related bugs cause critical issues and it is difficult to debug them.</p>
</blockquote>
<p>Indeed, write barrier bugs can be very elusive. I certainly don&rsquo;t put it past myself to accidentally introduce one. They are hard to spot by testing. To illustrate, try removing or changing lines that start with <code>GC</code> in the reproducer &ndash; a lot of the time the program doesn&rsquo;t crash and appears to work correctly.</p>
<p>I&rsquo;m going to suggest some ways that can make forgetting to insert and/or accidentally removing write barriers more difficult.</p>
<h3 id="education-and-code-reviews">Education and code reviews</h3>
<p>It&rsquo;s easy to forget to check for write barriers because a lot of the time one can compose the desired code change from pre-existing functions that already deal with write barriers correctly. Maybe the only thing that was stopping someone from catching this particular write barrier removal was a reminder to look for it. A gentle reminder on Github&rsquo;s pull request template could make sense.</p>
<p>I also think more people should understand write barriers enough that they know when to insert them. Write barriers form a very important contract between the GC and the rest of the virtual machine. People making changes should be aware of this contract.</p>
<h3 id="static-analysis">Static analysis</h3>
<p>Humans are unreliable and can easily make mistakes. It would be ideal if we could run a program and get an assessment as to whether a write barrier is missing. For this particular case, it seems reasonable to write a Clang-based static analyzer that could catch it. However, I don&rsquo;t know how useful that would be for unknown cases that might reveal themselves in the future. Also, the ergonomics of static analyzers are hard to get right. Among other potential issues, just a few false alarms can make them too annoying to use.</p>
<p>Nevertheless, maybe it&rsquo;s worth it to make a best-effort static analyzer to help new contributors and experienced ones alike.</p>
<h2 id="summary">Summary</h2>
<ul>
<li>Write barriers are an important part of Ruby&rsquo;s incremental GC that updates the GC&rsquo;s understanding of the object reference graph</li>
<li>CRuby developers are responsible for manually inserting write barriers wherever necessary</li>
<li>Failing to insert write barriers can cause catastrophic failures such as crashes and data corruption</li>
</ul>
<h2 id="footnotes">Footnotes</h2>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>This is a textbook tri-color mark algorithm. Typically, the three colors are white, grey, and black. I chose different colors in an effort to help <a href="https://davidmathlogic.com/colorblind">colorblind</a> readers.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

        </div>
        


<div class="post-info">
    
        <div class="post-date dt-published">2021-07-22</div>
    
    
    <a class="post-hidden-url u-url" href="https://alanwu.space/post/write-barrier/">https://alanwu.space/post/write-barrier/</a>
    <div class="post-hidden-author p-author"></div>

    <div class="post-taxonomies">
        
            
    </div>
</div>

    </article>

    

    

    


        </main>
        <footer class="common-footer"></footer>
    </div>
</body>
</html>
